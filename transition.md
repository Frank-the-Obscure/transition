# 公交线路客流预测

outline

- 赛题
- 起始思路
- 数据统计与处理


## 赛题

>本次大赛要求选手根据广州市内及广佛同城公交线路的历史公交刷卡数据，挖掘固定人群在公共交通中的行为模式。建立公交线路乘车人次预测模型，并用模型预测未来一周（20150101-20150107）每日06时至21时每小时段各个线路的乘车人次。Part2将更换一批新数据。

>大赛开放20140801至20141231五个月广东部分公交线路岭南通用户刷卡数据，共涉及近200万用户2条线路约800多万条数据记录。同时大赛提供20140801至20150131期间广州市的天气状况信息。

预测线路乘车人次

## 起始思路

先对已有数据进行统计和可视化, 分析数据规律.

## 数据统计与处理

使用 Pandas 进行数据处理. `first-test.ipynb`

1. 数据没有标签行, 在已有 data 前面加上标签行.

train data:
8926604 rows × 7 columns

用前1000行写测试文件

2. 初步测试 Pandas groupby

ok

dataframe.groupby('column_name').count() 可以很方便地进行统计

时间戳: 需要格式化

可以整理为文件存储, 或者转化成标准格式, 每次读取统计;

考虑使用次数, 如果需要反复调用并且数据量较大, 则应该预先处理(类似于准备一个完整的 feature 文件);

3. troubles

groupby等处理之后, 标签变成了第二行, 无法作为后续的行列标题.

尝试用时间序列调整每天的数据, 但是目前的数据 DataFrame 不是 Series, 似乎不可用.

4. 回归目标

目标: 两条线路的可视化

基本数据: 忽略用户层次信息, 只看统计结果

每天每小时两条线路的用户数量. 即下述表格:

- row: date time
- column: line 10/15
- data: count of people

未必一定要用 pandas. 处理完初步数据之后, 行数并不太多, excel等作图也可以考虑...

另外关于时间序列, 也可先用 python 处理成两列暂时统计着, 不必一直死磕. 有更多经验之后会处理得更好.


## First commit

1. 已有数据按照两条路线每天每小时归类
2. 可视化看趋势
3. 预测 CV 集
4. CV
5. 预测测试集并提交

### 1. 归类

基本正常, 有1000多 count 的时间标签格式不对, 暂时不管了(一共 900w)
转到 excel 里面做 pivottable

### 2. 可视化

`plot_1119.xlsx-plot_by_hour`: 按小时的plot

明显表现出早晚高峰的特征, 初步看来方差并不大.
可用平均值预测一次.

### 3. 预测 CV

### 4. CV 质控

### 5. 预测测试集

直接调整 excel 文件

0101用周日的数据

0102,0103用周六的数据

4,5,6,7用周一二三四的数据

只需要预测6-21的数据, 其它删去.


## 20151116 second commit

- 读取清理数据
- 拍脑门设计第二次提交

### 读取并清洗数据

初步看整体趋势:

随周末变化明显; 假期效果明显(9.6-8中秋; 10.1-7国庆: 9.28 10.11上班)

8.11-8.13, 8.15, 8.18数据明显异常

### 拍脑门设计第二次提交

从整体趋势看: 新年三天按 周六 周日 周日 预测可能比较科学
后面四天按 周一 周二 周三 周四 预测

数据先清理掉不正常的五天, 再清理掉所有的法定假期和调休

9.8

9.28

10.1-7

10.11

files:

整理的数据 `gd_train_data_1116.csv`

- 包括如下 features: `Use_city,Line_name,Terminal_id,Card_id,Create_city,Deal_time,Date,Hour,Weekday,Card_type`

归类后的数据 `count_1116.csv`

下面进入 excel 整理

`first_pivot`: 整理为 line 10/15 和横轴
 
`clean_up`: 清除掉上述异常值, 法定假日04和调休 

(inbox: 月份变化)

## 20151117 first model

### 整理 model 数据

cleaned data(去除特殊日期后) 6-21

X hour, is_workday
y line10 count

整理为 `matrix_1117.csv`

用 pandas 整理为 numpy array, 准备用

pandas 整理数据 提取矩阵好用

ipynb 跑 sklearn 也比较靠谱 `1117.ipynb`

输出为 np.txt, 后续应该整理为更好的格式, 输出回矩阵为好

需要一个一键生成最终 txt 的脚本

更长远则是 pipeline

```
line10 rf train 0.946813459599
line10 rf cv 0.949336870506
line15 rf train 0.927900606389
line15 rf cv 0.927390457474

```

precision: `1118`


## 20151118 second model `1118-2.ipynb`

weekday 转换为周一-周日的数据

- crosstab 整合信息
- 整理为 0/1 特征
- model/可视化
- CV
- predict

### crosstab 整合信息 by pandas

`train_1118.csv`: 基本信息

`weather_1118.csv`: 天气信息

用 `date` join 两个列表: `join_1118.csv`

`feature_01_1118.py`: 整理为01变量, `features_1118.csv`

0.992296797628
0.946711671255
0.990874187631
0.941209986176

### predict

数据未整理...迅速整理为相同格式的输入

写了简单的输出格式化脚本 `format_predict_1118.py`, 需要进一步整合成更大的 workflow

### todo 

hour 是否要转成 0/1 

1/1 可能要按周日预测, 而非周六(看一下十一的情况)

btw: 

1. log 保持跟踪很重要
2. 夜了...搞到一点实在累. 尽量避免

## 20151119 plot and CV `1119.ipynb`

Outline:

- 作图, 发现问题


### plot in matplotlib

`%matplotlib inline` in first cell

1118: precision 

line10 0.7735

line15 0.7331


测试 models

linear model 明显表现不行, SVM 表现也不行.

猜测是 hour 的问题, 转换为一系列 0/1 features

RF 无明显变化

linear model 与 SVM 表现有所提高, 但与 RF 仍有明显差距.

### final predict

50 features 预测

1.1-1.3 全部按周日预测

注: 最后 csv -> txt 需要改一下日期格式, 回头整合.


inbox: 也许可加一个异常天气变量(如 temp-ave_temp)表征异常天气

## 20151120 what's wrong?

- 昨夜提交的结果很差(56.81%), 先确定问题所在
- 确定之后, 再继续尝试提高在预测集上的表现; 
  - 也许应该固定预测集为某些日期 (如十二月最后几天)

### 确定问题

先排除明显的预测失误, 或者文件写错等问题

也就是说有1/4的数据格式不对...留待明天再测试正确的值吧

写代码, 可视化两个预测文件(final txt file), 便于对比

猜测是过拟合?

! **发现了明显的预测失误...所有的 6-9 没有写成 06-09**

大约会差 1/3 的预测值: 如果这么理想的话, 大约能提高到 75% (等待新的预测值)

不过, 与 1118 的预测相当相当接近(只在 1.1 是周六还是周日上有明显区别, 其余都是细微差别), 但 1118 只有 71.99%. 因此也并不乐观.

写可视化脚本, 从输出文件可视化 `compare_predict_1120.py`

matplotlib: 

用 x,y list 作图

可视化后发现一个明显的疑点: `predict_1118_1119.png`

最新的预测 1.1-1.3 的晚高峰都比早高峰还高?

查看已有数据, 似乎并没有这样的趋势

怀疑是过拟合导致的? 如何验证? 用训练数据(CV集可视化)

### 下一步

拍脑门不是很好的思路, 需要系统整理算法和结果. 通过 CV 寻找继续优化的方法.

需要进行的操作: 

1. 整理出部分数据集(固定划分一组 train/CV set)
2. workflow 来可视化对应的结果d

行动:

1. `1120.ipynb`: 分隔数据集, 用 12.25-12.31 作为测试集
2. 初步可视化: 在这几天之中, 似乎周六的表现最差
  - 有必要具体挑出误差最大的一些点, 来进行后续分析

拍脑门预测大法:

手动调整如下曲线: 参照 12月末, 调整 1.1-1.3 早晚高峰(下调), 1.4 早高峰(下调)